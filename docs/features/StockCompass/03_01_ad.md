
#### è©³ç´°
- 01-01:å¯¾è±¡ã®éŠ˜æŸ„ã®é¸åˆ¥
  - input sptch_stock_selections_header sptch_stock_selections_stocks sptch_simulation_periods
  - output sptch_simulation_results_stocks
- 02-01:EntrySignalæ¡ä»¶ã®Næ—¥å‰ã‚’ç¢ºèª
  - input sptch_signals
- 02-02:é–‹å§‹æ—¥ã®Næ—¥å‰ã‚’å–å¾—
  - input sptch_simulation_periods 
  - getDaysNBefore
- 02-03:ExitSignalæ¡ä»¶ã®Mæ—¥å¾Œã‚’ç¢ºèª
  - input sptch_exit_signals
- 02-04:çµ‚äº†æ—¥ã®Mæ—¥å¾Œã‚’å–å¾—
  - input sptch_simulation_periods
  - getDaysMAfter
- 02-05:éŠ˜æŸ„ã®é…åˆ—ã®ï¼‘ã¤ç›®ã‚’æŒ‡å®š
  - input sptch_simulation_results_stocks
- 03-01:éŠ˜æŸ„ã«å¯¾ã—ã¦ã®å‡¦ç†é–‹å§‹
  - input sptch_simulation_results_stocks
- 03-02:éŠ˜æŸ„ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ãŒé–‹å§‹æ—¥ã®Næ—¥å‰ã€çµ‚äº†æ—¥ã®Mæ—¥å¾Œã‚’å«ã‚“ã§ã„ã‚‹ã‹ï¼Ÿ
  - input spt_daily_quotes
- 03-03:é–‹å§‹æ—¥Næ—¥å‰ã€çµ‚äº†æ—¥Mæ—¥å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  - input spt_daily_quotes
- 03-04:é–‹å§‹æ—¥Næ—¥å‰ã€çµ‚äº†æ—¥Mæ—¥å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  - input spt_daily_quotes
- 03-05:é–‹å§‹æ—¥ã‚’åŸºæº–æ—¥ã¨ã—ã¦è©•ä¾¡é–‹å§‹
- 04-01:åŸºæº–æ—¥ã§ã®EntrySignalã®è©•ä¾¡
  - input sptch_signals sptch_entry_signals
- 04-02:åŸºæº–æ—¥ã§ã®Entry
  - input sptch_signals sptch_entry_signals sptch_trade_parameters
  - output sptch_simulation_results_trade
- 04-03:Exitæ—¥ã§ã®Exit
  - input sptch_signals sptch_exit_signals sptch_fee_taxes
  - output sptch_simulation_results_trade
- 04-04:è©•ä¾¡ã€ç™»éŒ²
  - output sptch_simulation_results
- 04-05:ç¿Œæ—¥ãŒçµ‚äº†æ—¥ä»¥å‰
- 05-01:æ¬¡ã®éŠ˜æŸ„ã¸
- 06-01:çµ‚äº†å‡¦ç†ã€è¨˜éŒ²ç™»éŒ²
  - output sptch_simulation_results
- 
- 
é–¢é€£ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆè©³ç´°ï¼‰
sptch_analysis_conditions: FormulatePlanã§å®šç¾©ã•ã‚Œã‚‹ã™ã¹ã¦ã®æ¡ä»¶ã®çµ„ã¿åˆã‚ã›ã‚’æŒ‡ã—ç¤ºã™ãƒ¡ã‚¤ãƒ³ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚ã“ã“ã§ä½œæˆã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚
sptch_stock_selections_header: éŠ˜æŸ„é¸æŠæ¡ä»¶ã®ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã€‚
sptch_stock_selections_stocks: éŠ˜æŸ„é¸æŠæ¡ä»¶ã®å®Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆå€‹ã€…ã®éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ï¼‰ã€‚
sptch_simulation_periods: ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“æ¡ä»¶ã€‚
sptch_trade_parameters: å–å¼•å‰ææ¡ä»¶ã€‚
sptch_signals: å£²è²·ã‚·ã‚°ãƒŠãƒ«æ¡ä»¶ï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ»ã‚¨ã‚°ã‚¸ãƒƒãƒˆã®ã‚»ãƒƒãƒˆï¼‰ã€‚
sptch_entry_signals: ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚·ã‚°ãƒŠãƒ«æ¡ä»¶ã®è©³ç´°ï¼ˆJSONBå½¢å¼ã§å…·ä½“çš„ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’æ ¼ç´ï¼‰ã€‚
sptch_exit_signals: ã‚¨ã‚°ã‚¸ãƒƒãƒˆã‚·ã‚°ãƒŠãƒ«æ¡ä»¶ã®è©³ç´°ï¼ˆJSONBå½¢å¼ã§å…·ä½“çš„ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’æ ¼ç´ï¼‰ã€‚
sptch_fee_taxes: æ‰‹æ•°æ–™ãƒ»ç¨é‡‘æ¡ä»¶ã€‚

sptch_analysis_conditions
â”œâ”€â”€ sptch_simulation_results_stocks   â† ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°éŠ˜æŸ„çµæœ
â”œâ”€â”€ sptch_simulation_results_trade    â† ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ
â”œâ”€â”€ sptch_simulation_results_summary  â† ãƒ—ãƒ©ãƒ³å…¨ä½“ã®ç·åˆæç›Š
â”œâ”€â”€ sptch_simulation_results          â† ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡ŒçŠ¶æ³ã¨å…¨ä½“çµæœ
â”‚   â””â”€â”€ sptch_simulation_logs         â† å„å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã®å®Ÿè¡Œãƒ­ã‚°



# market_calendar
ä»¥ä¸‹ã¯ã€**æ ªå¼å¸‚å ´ã®å–¶æ¥­æ—¥ç®¡ç†ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆPostgreSQL/Supabaseç”¨ï¼‰**ã®è¨­è¨ˆæ¡ˆã§ã™ã€‚
---

## âœ… å–¶æ¥­æ—¥ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆæ¡ˆ `market_calendar`

| åˆ—å        | å‹                 | èª¬æ˜                       |
| --------- | ----------------- | ------------------------ |
| `date`    | `DATE` (PK)       | å¯¾è±¡æ—¥ä»˜ï¼ˆä¾‹: `2025-07-04`ï¼‰    |
| `is_open` | `BOOLEAN`         | å–¶æ¥­æ—¥ã‹ã©ã†ã‹ï¼ˆtrue = å–¶æ¥­æ—¥ï¼‰      |
| `note`    | `TEXT` (nullable) | å‚™è€ƒï¼ˆä¾‹: "æ†²æ³•è¨˜å¿µæ—¥", "å¤§ç™ºä¼š" ãªã©ï¼‰ |

---

### ğŸ¯ ä¸»ãªç‰¹å¾´ã¨ãƒ¡ãƒªãƒƒãƒˆ

| æ©Ÿèƒ½             | å†…å®¹                                        |
| -------------- | ----------------------------------------- |
| âœ” ä¸»ã‚­ãƒ¼ï¼š`date`   | æ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«åˆ¤å®š                             |
| âœ” é«˜é€Ÿæ¤œç´¢         | `WHERE date = 'YYYY-MM-DD'` ã§å–¶æ¥­æ—¥åˆ¤å®š        |
| âœ” å°†æ¥ã®æ‹¡å¼µæ€§       | `note` ã‚’ä½¿ã£ã¦ç¥æ—¥åã‚„ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ å¯èƒ½                   |
| âœ” éå–¶æ¥­æ—¥ã®ç†ç”±ã‚‚ä¿å­˜å¯èƒ½ | `is_open = false` ã‹ã¤ `note = 'å¹´æœ«å¹´å§‹ä¼‘æ¥­'` ãªã© |

---

## ğŸ§© åˆ©ç”¨ä¾‹ï¼ˆSQLã‚¯ã‚¨ãƒªï¼‰

### â‘  ä»Šæ—¥ãŒå–¶æ¥­æ—¥ã‹ï¼Ÿ

```sql
SELECT is_open FROM market_calendar WHERE date = CURRENT_DATE;
```

### â‘¡ æ¬¡ã®å–¶æ¥­æ—¥ã‚’æ¢ã™

```sql
SELECT date FROM market_calendar
WHERE date > CURRENT_DATE AND is_open = true
ORDER BY date
LIMIT 1;
```

### â‘¢ éå»30å–¶æ¥­æ—¥åˆ†ã®å–å¾—

```sql
SELECT date FROM market_calendar
WHERE date <= CURRENT_DATE AND is_open = true
ORDER BY date DESC
LIMIT 30;
```

---

## ğŸ’¾ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆSQLï¼ˆPostgreSQL / Supabaseç”¨ï¼‰

```sql
CREATE TABLE market_calendar (
    date DATE PRIMARY KEY,
    is_open BOOLEAN NOT NULL,
    note TEXT
);
```
### Supabaseã®å ´åˆï¼š

1. Supabase Studioã«ãƒ­ã‚°ã‚¤ãƒ³
2. `market_calendar` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
3. ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‹ã‚‰CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°


### 1. `ImportMarketCalendar`
- CSVãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ãªç”»é¢
- æ›¸å¼ä¾‹ï¼š`date,is_open,note`  
  `2025-07-21,false,æµ·ã®æ—¥`

### 2. `MarketCalendarList`
- æŒ‡å®šå¹´ã®å–¶æ¥­æ—¥ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ç”»é¢
- å¹´ã®å¤‰æ›´ãŒå¯èƒ½ã€æ›œæ—¥ã¨å–¶æ¥­çŠ¶æ³ï¼ˆOpen / Closeï¼‰ã‚’è¡¨ç¤º
- é–“é•ã„ç¢ºèªãƒ»ãƒ¡ãƒ³ãƒ†ç”¨ã«è‰²åˆ†ã‘ã‚ã‚Šï¼ˆéå–¶æ¥­æ—¥ã¯èµ¤èƒŒæ™¯ï¼‰


### TypeScript NextJSTailWindcss
``` ts
// market_calendarç®¡ç†ç”¨UIï¼ˆNext.js + TailwindCSSï¼‰

"use client";

import React, { useState, useEffect } from "react";
import { format, parseISO, getDay } from "date-fns";
import ja from "date-fns/locale/ja";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Select, SelectItem } from "@/components/ui/select";

// æ›œæ—¥è¡¨è¨˜ç”¨
const dayOfWeek = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];

// CSVã‚’è²¼ã‚Šä»˜ã‘ â†’ DBã¸ç™»éŒ²ç”»é¢
export function ImportMarketCalendar() {
  const [csvText, setCsvText] = useState("");
  const [message, setMessage] = useState("");

  const handleImport = async () => {
    try {
      const rows = csvText.trim().split("\n").slice(1); // skip header
      const data = rows.map((line) => {
        const [date, isOpen, note] = line.split(",");
        return { date, is_open: isOpen === "true", note };
      });
      const res = await fetch("/api/market-calendar/import", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data }),
      });
      if (!res.ok) throw new Error("Import failed");
      setMessage("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«æˆåŠŸã—ã¾ã—ãŸã€‚");
    } catch (err) {
      console.error(err);
      setMessage("ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }
  };

  return (
    <Card className="max-w-3xl mx-auto my-4">
      <CardContent className="space-y-4">
        <h2 className="text-xl font-bold">å–¶æ¥­æ—¥CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
        <Textarea
          rows={10}
          value={csvText}
          onChange={(e) => setCsvText(e.target.value)}
          placeholder="date,is_open,note\n2025-07-21,false,æµ·ã®æ—¥"
        />
        <Button onClick={handleImport}>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</Button>
        {message && <p className="text-sm text-green-700">{message}</p>}
      </CardContent>
    </Card>
  );
}

// ä¸€è¦§ç”»é¢ï¼ˆå¹´æŒ‡å®šï¼‰
export function MarketCalendarList() {
  const thisYear = new Date().getFullYear();
  const [year, setYear] = useState(thisYear);
  const [records, setRecords] = useState([]);

  useEffect(() => {
    fetch(`/api/market-calendar?year=${year}`)
      .then((res) => res.json())
      .then((data) => setRecords(data));
  }, [year]);

  return (
    <Card className="max-w-5xl mx-auto my-8">
      <CardContent>
        <div className="flex items-center gap-4 mb-4">
          <label>å¹´æŒ‡å®šï¼š</label>
          <Input
            type="number"
            value={year}
            onChange={(e) => setYear(Number(e.target.value))}
            className="w-32"
          />
        </div>
        <div className="overflow-x-auto">
          <table className="w-full border text-sm">
            <thead>
              <tr className="bg-gray-100">
                <th className="p-2 border">æ—¥ä»˜</th>
                <th className="p-2 border">æ›œæ—¥</th>
                <th className="p-2 border">å‚™è€ƒ</th>
                <th className="p-2 border">å–¶æ¥­</th>
              </tr>
            </thead>
            <tbody>
              {records.map((r: any) => {
                const dateObj = parseISO(r.date);
                const dow = dayOfWeek[getDay(dateObj)];
                return (
                  <tr key={r.date} className={r.is_open ? "" : "bg-red-50"}>
                    <td className="p-1 border">{format(dateObj, "yyyy.MM.dd")}</td>
                    <td className="p-1 border">{dow}</td>
                    <td className="p-1 border">{r.note || ""}</td>
                    <td className="p-1 border">{r.is_open ? "Open" : "Close"}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </CardContent>
    </Card>
  );
}
``` 