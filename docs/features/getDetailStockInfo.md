[Top](../README.md)

### ğŸ“Š æ ªå¼æŠ•è³‡ã®å‚è€ƒæŒ‡æ¨™ä¸€è¦§

| æŒ‡æ¨™å                | å€¤ï¼ˆã¾ãŸã¯èª¬æ˜ï¼‰             | è£œè¶³ãƒ»ç®—å‡ºå¼ãªã©    | ç”¨é€”ãƒ»æ„ç¾©            | å„ªå…ˆåº¦ |
| ------------------ | -------------------- | ----------- | ---------------- | --- |
| **æ™‚ä¾¡ç·é¡**           | 990,024ç™¾ä¸‡å†† (10:21)   | æ ªä¾¡ Ã— ç™ºè¡Œæ¸ˆæ ªå¼æ•° | ä¼æ¥­è¦æ¨¡ã®æŠŠæ¡          | é«˜   |
| **ç™ºè¡Œæ¸ˆæ ªå¼æ•°**         | 581,000,000æ ª (06/11) | -           | æ™‚ä¾¡ç·é¡ãƒ»EPSç­‰ã®è¨ˆç®—ã«ä½¿ç”¨  | é«˜   |
| **é…å½“åˆ©å›ã‚Šï¼ˆä¼šç¤¾äºˆæƒ³ï¼‰**    | 2.46% (10:21)        | å¹´é–“é…å½“ Ã· æ ªä¾¡   | é…å½“é‡è¦–ã®æŠ•è³‡åˆ¤æ–­        | é«˜   |
| **1æ ªé…å½“ï¼ˆä¼šç¤¾äºˆæƒ³ï¼‰**     | 42.00å†† (2026/03)     | å¹´é–“é…å½“äºˆå®šé¡     | é…å½“é‡‘ã®äºˆæ¸¬           | é«˜   |
| **PERï¼ˆä¼šç¤¾äºˆæƒ³ï¼‰**      | (é€£)17.01å€ (10:21)    | æ ªä¾¡ Ã· EPS    | å‰²å®‰ãƒ»å‰²é«˜ã®ç›®å®‰         | é«˜   |
| **PBRï¼ˆå®Ÿç¸¾ï¼‰**        | (é€£)1.38å€ (10:21)     | æ ªä¾¡ Ã· BPS    | ç´”è³‡ç”£ã«å¯¾ã™ã‚‹æ ªä¾¡ã®å€ç‡     | é«˜   |
| **EPSï¼ˆä¼šç¤¾äºˆæƒ³ï¼‰**      | (é€£)100.17å†† (2026/03) | 1æ ªã‚ãŸã‚Šåˆ©ç›Š     | åç›ŠåŠ›ã®æŒ‡æ¨™ã€PERè¨ˆç®—ã«ã‚‚ä½¿ç”¨ | é«˜   |
| **BPSï¼ˆå®Ÿç¸¾ï¼‰**        | (é€£)1,233.27å††         | 1æ ªã‚ãŸã‚Šç´”è³‡ç”£    | PBRè¨ˆç®—ã«ä½¿ç”¨         | é«˜   |
| **ROEï¼ˆå®Ÿç¸¾ï¼‰**        | (é€£)7.76%             | ç´”åˆ©ç›Š Ã· è‡ªå·±è³‡æœ¬  | æ ªä¸»è¦–ç‚¹ã®åç›Šæ€§         | é«˜   |
| **è‡ªå·±è³‡æœ¬æ¯”ç‡ï¼ˆå®Ÿç¸¾ï¼‰**     | (é€£)35.3%             | è‡ªå·±è³‡æœ¬ Ã· ç·è³‡ç”£  | è²¡å‹™å¥å…¨æ€§ã®æŒ‡æ¨™         | é«˜   |
| **æœ€ä½è³¼å…¥ä»£é‡‘**         | 170,400å†† (10:21)     | æ ªä¾¡ Ã— å˜å…ƒæ ªæ•°   | æŠ•è³‡ã‚³ã‚¹ãƒˆã®ç›®å®‰         | é«˜   |
| **å˜å…ƒæ ªæ•°**           | 100æ ª                 | -           | å£²è²·å˜ä½ã®ç¢ºèª          | é«˜   |
| **å¹´åˆæ¥é«˜å€¤**          | 2,125å†† (25/04/23)    | -           | æ ªä¾¡ä¸Šé™ã®ç›®å®‰          | é«˜   |
| **å¹´åˆæ¥å®‰å€¤**          | 1,594å†† (25/01/06)    | -           | æ ªä¾¡ä¸‹é™ã®ç›®å®‰          | é«˜   |
| **å–¶æ¥­åˆ©ç›Šï¼ˆEBITï¼‰**     | åˆ©ç›Šã®æºæ³‰                | å£²ä¸Šé«˜ï¼è²»ç”¨      | æœ¬æ¥­ã®åˆ©ç›ŠåŠ›           | ä¸­   |
| **å–¶æ¥­åˆ©ç›Šç‡**          | å–¶æ¥­åˆ©ç›Š Ã· å£²ä¸Šé«˜           | %è¡¨ç¤º         | åˆ©ç›Šä½“è³ªã®å¼·ã•          | ä¸­   |
| **ãƒ•ãƒªãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼**    | å®Ÿéš›ã«ä½¿ãˆã‚‹ç¾é‡‘             | å–¶æ¥­CFï¼æŠ•è³‡CF   | è²¡å‹™ä½™åŠ›ãƒ»é‚„å…ƒåŠ›         | ä¸­   |
| **ROAï¼ˆç·è³‡ç”£åˆ©ç›Šç‡ï¼‰**    | ç´”åˆ©ç›Š Ã· ç·è³‡ç”£            | %è¡¨ç¤º         | çµŒå–¶åŠ¹ç‡æ€§ã®ç¢ºèª         | ä¸­   |
| **æµå‹•æ¯”ç‡**           | æµå‹•è³‡ç”£ Ã· æµå‹•è² å‚µ          | Ã—100%       | çŸ­æœŸæ”¯æ‰•èƒ½åŠ›           | ä¸­   |
| **å½“æœŸç´”åˆ©ç›Š**          | æœ€çµ‚çš„ãªåˆ©ç›Š               | å£²ä¸Šç·åˆ©ç›Šï¼å…¨è²»ç”¨   | EPSã®æº            | ä¸­   |
| **é…å½“æ€§å‘**           | é…å½“ Ã· ç´”åˆ©ç›Š             | %è¡¨ç¤º         | åˆ©ç›Šé…åˆ†æ–¹é‡ã®ç¢ºèª        | ä¸­   |
| **PEGãƒ¬ã‚·ã‚ª**         | PER Ã· äºˆæƒ³æˆé•·ç‡          | ä½ã„ã¨å‰²å®‰æ„Ÿã‚ã‚Š    | æˆé•·æ€§ã¨å‰²å®‰æ€§ã®ãƒãƒ©ãƒ³ã‚¹     | ä¸­   |
| **ãƒ™ãƒ¼ã‚¿å€¤ï¼ˆÎ²ï¼‰**        | æ ªä¾¡ã®å¸‚å ´é€£å‹•æ€§             | 1ä»¥ä¸Šï¼šå¸‚å ´ã‚ˆã‚Šå¤‰å‹•å¤§ | ãƒªã‚¹ã‚¯è©•ä¾¡            | ä¸­   |
  | **ã‚¤ãƒ³ã‚¿ãƒ¬ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ã‚·ã‚ª** | å–¶æ¥­åˆ©ç›Š Ã· æ”¯æ‰•åˆ©æ¯          | é«˜ã„æ–¹ãŒå®‰å¿ƒ      | å€Ÿå…¥è¿”æ¸ˆä½™åŠ›           | ä¸­   |
| **çŸ­æœŸå€Ÿå…¥é‡‘ / é•·æœŸè² å‚µ**   | å€Ÿå…¥ã®å†…è¨³                | æ§‹æˆãƒãƒ©ãƒ³ã‚¹      | å€Ÿå…¥ã®å®‰å®šæ€§åˆ†æ         | ä¸­   |

---


ã”ä¾é ¼ã®è¦ä»¶ã«åŸºã¥ãã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã® `Action/getCompanyStockDetail` ã«ã¦ã€æ¬¡ã®ã‚ˆã†ãªãƒ•ãƒ­ãƒ¼ã‚’æƒ³å®šã—ãŸå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

### âœ… å‡¦ç†ãƒ•ãƒ­ãƒ¼æ¦‚è¦ï¼š`getCompanyStockDetail`

1. **æ ªå¼ã‚³ãƒ¼ãƒ‰ï¼ˆtickerï¼‰ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹**
2. **`spt_company_stock_details` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‚ç…§**

   * å½“æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚Œã°ã€ãã®ã¾ã¾è¿”å´ã€‚
3. **ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯æ›´æ–°æ—¥æ™‚ãŒå¤ã„å ´åˆï¼ˆå‰æ—¥ä»¥å‰ï¼‰**

   * YahooFinance2 API ã‹ã‚‰æœ€æ–°æƒ…å ±ã‚’å–å¾—ã€‚
   * `spt_company_stock_details` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ï¼ˆINSERT or UPSERTï¼‰ã€‚
   * æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¿”å´ã€‚

---

### ğŸ—ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ï¼ˆ`spt_company_stock_details`ï¼‰


### ğŸ’¡ å–å¾—ãƒ»æ›´æ–°å‡¦ç†ã®TypeScriptä¾‹ï¼ˆNext.jsã®Actioné–¢æ•°ï¼‰


<details><summary>TypeScript</summary>


```ts
// app/api/getCompanyStockDetail/route.ts (ã¾ãŸã¯é©åˆ‡ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ« src/app/actions/company.actions.ts ãªã©)
"use server"; // Next.js Server Actionã¨ã—ã¦ãƒãƒ¼ã‚¯ã™ã‚‹å ´åˆ

import { createClient } from "@/util/supabase/server"; // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã‚’å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ãã ã•ã„
import { fetchStockFromYahoo } from "@/lib/yahoo"; // Yahoo Financeã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•° (ã“ã‚Œã¯æ—¢å­˜ã®ã‚‚ã®ã‚’åˆ©ç”¨)

// spt_company_stock_details ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‹å®šç¾© (å®Ÿéš›ã®ã‚«ãƒ©ãƒ ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„)
interface CompanyStockDetail {
  code: string;
  market_cap?: number | null;
  issued_shares?: number | null;
  div_yield?: number | null;
  dividend?: number | null;
  per?: number | null;
  pbr?: number | null;
  eps?: number | null;
  bps?: number | null;
  roe?: number | null;
  equity_ratio?: number | null;
  min_price?: number | null;
  unit_shares?: number | null;
  high_price_ytd?: number | null;
  low_price_ytd?: number | null;
  updated_at: string; // YYYY-MM-DD
  // fetchStockFromYahooã‹ã‚‰è¿”ã•ã‚Œã‚‹ãŒã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ¼ãƒã«å«ã¾ã‚Œãªã„å¯èƒ½æ€§ã®ã‚ã‚‹è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  // [key: string]: any;
}

export async function getCompanyStockDetail(
  code: string
): Promise<CompanyStockDetail | null> {
  const supabase = await createClient();
  const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

  // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const { data: existingData, error: fetchError } = await supabase
    .from("spt_company_stock_details")
    .select("*")
    .eq("ticker", ticker)
    .single();

  if (fetchError && fetchError.code !== "PGRST116") {
    // PGRST116ã¯ã€Œè¡ŒãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã‚¨ãƒ©ãƒ¼ã§ã€ã“ã®å ´åˆã¯å•é¡Œãªã„ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã‚‹ï¼‰
    console.error(
      `Error fetching existing stock detail for ${ticker}:`,
      fetchError
    );
    throw new Error(
      `æ—¢å­˜ã®æ ªå¼è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${fetchError.message}`
    );
  }

  const existing = existingData as CompanyStockDetail | null;

  // updated_at ãŒ DATE å‹ã§ YYYY-MM-DD å½¢å¼ã®æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã•ã‚Œã‚‹ã¨ä»®å®š
  if (existing && existing.updated_at === today) {
    console.log(
      `Returning existing, up-to-date stock detail for ${ticker} from DB.`
    );
    return existing;
  }

  // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—
  console.log(
    `Fetching latest stock detail for ${ticker} from Yahoo Finance.`
  );
  const latest = await fetchStockFromYahoo(ticker); // fetchStockFromYahooã¯CompanyStockDetailã®ä¸€éƒ¨ã¾ãŸã¯äº’æ›æ€§ã®ã‚ã‚‹å‹ã‚’è¿”ã™ã¨ä»®å®š
  if (!latest) {
    console.error(`Failed to fetch latest stock detail for ${ticker}.`);
    throw new Error("æœ€æ–°ã®æ ªå¼è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }

  // DBã‚’æ›´æ–°ï¼ˆUPSERTï¼‰
  // `latest` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ `updated_at: today` ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æœŸå¾…
  // ã¾ãŸã€`ticker` ã‚‚å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹
  const dataToUpsert: CompanyStockDetail = {
    ticker, // tickerã‚’æ˜ç¤ºçš„ã«å«ã‚ã‚‹
    ...(latest as Omit<CompanyStockDetail, "ticker">), // latestã®å‹ã‚’èª¿æ•´
    updated_at: today, // å¿µã®ãŸã‚ä¸Šæ›¸ãã€ã¾ãŸã¯latestãŒã“ã‚Œã‚’å«ã‚“ã§ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
  };

  console.log(`Upserting stock detail for ${ticker} into DB.`);
  const { data: upsertedData, error: upsertError } = await supabase
    .from("spt_company_stock_details")
    .upsert(dataToUpsert, { onConflict: "ticker" })
    .select() // upsertå¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ãŸã„å ´åˆ
    .single(); // 1è¡Œã ã‘æ›´æ–°/æŒ¿å…¥ã•ã‚Œã‚‹ã¯ãš

  if (upsertError) {
    console.error(`Error upserting stock detail for ${ticker}:`, upsertError);
    throw new Error(
      `æ ªå¼è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${upsertError.message}`
    );
  }

  console.log(`Successfully upserted stock detail for ${ticker}.`);
  // upsertedData ãŒ null ã®å ´åˆã‚‚è€ƒæ…® (ä¾‹: RLSã§selectæ¨©é™ãŒãªã„å ´åˆãªã©)
  // åŸºæœ¬çš„ã«ã¯ upsert ã—ãŸãƒ‡ãƒ¼ã‚¿ (latest ã«åŸºã¥ã) ã‚’è¿”ã™ã®ãŒé©åˆ‡
  return upsertedData || dataToUpsert;
}
```

</details>


---

### ğŸ§© YahooFinance2ã‹ã‚‰ã®å–å¾—å‡¦ç†ã®ä¾‹

```ts
// lib/yahoo.ts
export async function fetchStockFromYahoo(ticker: string) {
  const res = await fetch(`https://query2.finance.yahoo.com/v10/finance/quoteSummary/${ticker}?modules=defaultKeyStatistics,financialData`);
  const json = await res.json();

  // ã“ã“ã§JSONã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦å¿…è¦ãªå€¤ã«å¤‰æ›
  const data = json.quoteSummary.result[0];

  return {
    market_cap: data.defaultKeyStatistics.marketCap?.raw / 1_000_000 ?? null, // ç™¾ä¸‡å††
    issued_shares: data.defaultKeyStatistics.sharesOutstanding?.raw ?? null,
    div_yield: data.summaryDetail.dividendYield?.raw * 100 ?? null, // %
    dividend: data.summaryDetail.dividendRate?.raw ?? null,
    per: data.summaryDetail.trailingPE?.raw ?? null,
    pbr: data.defaultKeyStatistics.priceToBook?.raw ?? null,
    eps: data.defaultKeyStatistics.trailingEps?.raw ?? null,
    bps: data.defaultKeyStatistics.bookValue?.raw ?? null,
    roe: data.financialData.returnOnEquity?.raw * 100 ?? null, // %
    equity_ratio: data.financialData.quickRatio?.raw ?? null, // â€»QuickRatio ã‚’ä»®ã§ä½¿ç”¨ã€‚è¦èª¿æ•´
    min_price: data.price.regularMarketPrice?.raw * 100 ?? null, // å˜å…ƒæ ªæ•°100æ ªå‰æ
    unit_shares: data.price.sharesPerMarketCap?.raw ?? 100, // ä»®ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€‚å¿…è¦ã«å¿œã˜ã¦è£œå®Œ
    high_price_ytd: data.summaryDetail.fiftyTwoWeekHigh?.raw ?? null,
    low_price_ytd: data.summaryDetail.fiftyTwoWeekLow?.raw ?? null,
    // ä»¥ä¸‹ã¯è¿½åŠ ã§å‚è€ƒã«ãªã‚‹å€¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦DBã‚¹ã‚­ãƒ¼ãƒã‚‚æ‹¡å¼µï¼‰
    roa: data.financialData.returnOnAssets?.raw * 100 ?? null, // %
    operating_margin: data.financialData.operatingMargins?.raw * 100 ?? null, // %
    free_cash_flow: data.financialData.freeCashflow?.raw / 1_000_000 ?? null, // ç™¾ä¸‡å††
    interest_coverage: data.financialData.ebitda?.raw / data.financialData.interestExpense?.raw ?? null,
    beta: data.defaultKeyStatistics.beta?.raw ?? null,
    peg_ratio: data.defaultKeyStatistics.pegRatio?.raw ?? null,
    updated_at: new Date().toISOString().slice(0, 10),
  };
}
```

---

### ğŸ” æ³¨æ„ç‚¹

* `ticker` ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã«è¨­å®šã€‚
* `updated_at` ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è²¼ã‚‹ã“ã¨ã§å–å¾—é«˜é€ŸåŒ–ã€‚
* `fetchStockFromYahoo` ã§ã¯ã€APIåˆ¶é™ã‚„nullãƒã‚§ãƒƒã‚¯ãŒå¿…è¦ã€‚

##ã€€YahooFinance2ã§å–å¾—ã§ãã‚‹ã‚‚ã®
ä¸»ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ãã®ä¸­èº«
|ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å|	èª¬æ˜|	å–å¾—ã§ãã‚‹æŒ‡æ¨™ä¾‹|
|-|-|-|
|defaultKeyStatistics|	è²¡å‹™æ¯”ç‡ã‚„ç™ºè¡Œæ ªå¼é–¢é€£|	âœ… priceToBook, sharesOutstanding, enterpriseValue, pegRatio|
|financialData|	æç›Šãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼é–¢é€£|	âœ… ebitda, grossMargins, returnOnEquity, freeCashflow, totalDebt|
|summaryDetail|	æ ªä¾¡ãƒ»é…å½“ãƒ»åˆ©å›ã‚Šãªã©|	âœ… dividendYield, trailingPE, marketCap, beta|
|price|	æ ªä¾¡ã¨å–å¼•å¸‚å ´|	âœ… regularMarketPrice, currency, exchangeName|
|incomeStatementHistory|	éå»ã®æç›Šè¨ˆç®—æ›¸ï¼ˆå¹´åº¦ï¼‰|	âœ… totalRevenue, netIncome, costOfRevenue|
|balanceSheetHistory|	éå»ã®ãƒãƒ©ãƒ³ã‚¹ã‚·ãƒ¼ãƒˆï¼ˆå¹´åº¦ï¼‰|	âœ… totalAssets, totalLiabilities, totalStockholderEquity|


---


https://github.com/gadicc/node-yahoo-finance2


## ğŸ¯ å®Ÿç”¨é¢ã§ç‰¹ã«ãŠã™ã™ã‚

ä»¥ä¸‹ã¯ã€ç‰¹ã«**ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚„æŠ•è³‡åˆ¤æ–­ã§æœ‰ç”¨**ãªæŒ‡æ¨™ã§ã™ï¼š

* **PEGãƒ¬ã‚·ã‚ªï¼ˆæˆé•·è€ƒæ…®ã—ãŸPERï¼‰**
* **ãƒ•ãƒªãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ï¼ˆè²¡å‹™ã®å¥å…¨æ€§ï¼‰**
* **ROEï¼ˆæ ªä¸»è¦–ç‚¹ã®åŠ¹ç‡æ€§ï¼‰**
* **å–¶æ¥­åˆ©ç›Šç‡ï¼ˆåˆ©ç›Šæ§‹é€ ï¼‰**
* **é…å½“æ€§å‘ï¼ˆé…å½“ã®æŒç¶šæ€§ï¼‰**
* **ãƒ™ãƒ¼ã‚¿å€¤ï¼ˆãƒªã‚¹ã‚¯ï¼‰**

