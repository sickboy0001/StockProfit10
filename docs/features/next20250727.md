## 冗長性
### Posgresqlのヒストグラム・保存場所
#### 問題
- supabaseではサイズの限界あり
- 代わりのPosgresqlスペース検討が必要
- ヒストグラムの情報のみを想定
#### 対策
- 一部のテーブルのみ配置場所を変える
#### 検討

| サービス           | プラン | メモリ | SSD/NVMe   | 月額料金（税込）   | 時間課金 | 備考         |
| -------------- | --- | --- | ---------- | ---------- | ---- | ---------- |
| **シン・VPS**     | 2GB | 2GB | 100GB NVMe | **968円**   | なし   | 高速ディスク・安い  |
| **ConoHa VPS** | 4GB | 4GB | 100GB SSD  | **2,860円** | あり   | 柔軟だが高め     |
| **さくらVPS**     | 2GB | 2GB | 100GB SSD  | **1,320円** | なし   | 老舗・地方リージョン |


* 額料金・ディスクサイズ・性能を比較した表を提示します。（2025年7月時点） 
* シンVPSは７月まで割引あり（スタンダードコース）

| あなたの用途                  | 推奨             |
| ----------------------- | -------------- |
| 数GB程度・軽量DB・閲覧メイン        | SATA SSDでも問題なし |
| 年間数十GB以上・分析系SQL実行       | NVMe SSDが安心    |
| VACUUM処理やインデックス更新を頻繁に行う | NVMe SSDが圧倒的有利 |


#### 手順

##### VPS選択
「SakuraVPS」「Conoha」「シンVPS」が候補
- シンVPS
https://www.shin-vps.jp/
- SakuraVPS
https://vps.sakura.ad.jp/?_gl=1*mx2p7t*_gcl_aw*R0NMLjE3NTI4MjAzNDcuQ2p3S0NBand2dUxEQmhBT0Vpd0FQdEYwVmhEVGZyM1VnUmtScTVWeGRKUHpHUzE3TEdGUGNsaXpMcFdJQ3RfZDdyYks3LVAxS1haWXJSb0NucGdRQXZEX0J3RQ..*_gcl_au*NTQ3NzAwMTEwLjE3NTEzNDgwODU.

- CosnohaVPS
https://www.conoha.jp/wing/campaign/happysummer2025/?banner_id=b04_wing&utm_source=google&utm_medium=cpc&utm_campaign=brand&utm_content=wing&saf_src=google_g&saf_pt=&saf_kw=conoha&saf_dv=&saf_cam=11872000928&saf_grp=117979846280&saf_ad=762450171746&account_id=9545672138&saf_acc=9545672138&gad_source=1&gad_campaignid=11872000928&gbraid=0AAAAADrl84sIsqgVHKgY8uUr8zRk5MM1f&gclid=CjwKCAjwvuLDBhAOEiwAPtF0VpH53V5PqS5zpv7qobew-qnFkuEfp6qPI15xGhjEmUWJyLKRdyZJoxoCLd0QAvD_BwE

了解しました。**シン・VPS**（CentOS Stream や Ubuntu）に
**PostgreSQL**と、GUIで操作できる**pgAdmin**などのツールをセットアップする標準手順を以下にまとめます。
「VPSへSSHで接続できる前提」で進めます。

---

#### ✅ シン・VPSにPostgreSQL＋GUIツール導入手順

##### ① PostgreSQL本体のインストール

Ubuntu 22.04の場合（最新LTS）：

```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
```

CentOS Stream 9の場合：

```bash
sudo dnf install postgresql-server postgresql-contrib
sudo postgresql-setup --initdb
sudo systemctl enable --now postgresql
```

---

##### ② PostgreSQL設定（外部接続・パスワード設定）

PostgreSQLユーザーのパスワード設定：

```bash
sudo -i -u postgres
psql
\password postgres   ← パスワード設定
\q
exit
```

必要なら**pg\_hba.conf**を編集して外部接続許可：

```bash
sudo nano /etc/postgresql/*/main/pg_hba.conf    # Ubuntu
sudo nano /var/lib/pgsql/data/pg_hba.conf       # CentOS
```

例：（信頼できるローカルPCのIPだけ許可）

```
host    all             all             192.168.0.0/24          md5
```

必要なら**postgresql.conf**でポート解放：

```bash
listen_addresses = '*'
```

PostgreSQL再起動：

```bash
sudo systemctl restart postgresql
```

---

##### ③ ファイアウォール設定（外部から接続する場合）

例：ポート5432を許可

```bash
sudo ufw allow 5432/tcp    # Ubuntu
sudo firewall-cmd --permanent --add-port=5432/tcp   # CentOS
sudo firewall-cmd --reload
```

---

##### ④ GUIツール（pgAdminなど）

###### パターンA：ローカルPCから使う

あなたのPCに**pgAdmin 4**をインストールして、VPSのPostgreSQLへ外部接続します。

* [pgAdmin公式ダウンロード](https://www.pgadmin.org/download/)
* VPS側の**グローバルIP**と**postgresパスワード**を使い接続設定

これが一般的で最も操作性が良いです。

---

###### パターンB：VPS上にpgAdmin Web版をインストールする場合

Webブラウザ経由で操作したいなら以下のように：

```bash
sudo apt install curl ca-certificates gnupg
curl https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo apt-key add
curl https://www.pgadmin.org/static/packages_pgadmin_org.pub | gpg --dearmor | sudo tee /usr/share/keyrings/pgadmin-keyring.gpg >/dev/null
echo "deb [signed-by=/usr/share/keyrings/pgadmin-keyring.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/ubuntu $(lsb_release -cs) pgadmin4" | sudo tee /etc/apt/sources.list.d/pgadmin4.list

sudo apt update
sudo apt install pgadmin4-web
sudo /usr/pgadmin4/bin/setup-web.sh
```

セットアップ後、**https\://VPS\_IP/pgadmin4** でGUI利用可能。
（ただしHTTPS証明書などは自分で設定する必要あり）

---

##### ⑤ セキュリティ注意

* インターネットに直接5432ポートを公開しない方が安全です。
* pgAdmin Web版を公開するなら、**.htpasswd認証**や**HTTPS**を必ず導入。

---

##### ✅ おすすめ構成

* VPSにはPostgreSQLだけ設置
* 自PCにpgAdmin（GUI）をインストールしてリモート接続
* VPSへの接続は**VPN経由**や**SSHトンネル**で制限できるとベスト

---

##### 補足

SSHトンネル経由でpgAdminを安全に使う手順も案内可能です。
ご希望ですか？（セキュリティを重視する場合おすすめです）



## 自動化

### 目的
- 定期的に調査して、調査結果をメールで連携するようにする
- メールサーバーの設定必要 Resend
- Functionからの呼び出しが必要GitHubアクション、Vercel側の処理検討必要

### 手順
**GitHub ActionsのCronジョブ**で**VercelのAPIやURL**を叩いて、Vercel側でバッチ処理やDB更新などを行いたい、ということですね。
以下に**具体的手順**を提示します。

---

#### ① Vercel側：URLエンドポイントの用意

* あなたの**Vercelプロジェクト**で以下を作成しておく：

  * **API Route**（例）：

    ```
    https://your-project.vercel.app/api/daily-job
    ```

* そのURLにGETまたはPOSTすれば、処理がVercel側で動く状態。

---

#### ② GitHubリポジトリの作成

* 既存のリポジトリ or 新規作成しておく

---

#### ③ GitHub Actions ワークフロー設定

1. リポジトリ内に以下のディレクトリを作成：

```
.github/workflows/
```

2. その中に例えば `vercel-cron.yml` というファイルを作成。

```yaml
name: Vercel Cron Trigger

on:
  schedule:
    - cron: '0 0 * * *'  # 毎日 0:00 実行（日本時間では+9時間ズレるので注意）
  workflow_dispatch:      # 手動実行も可能

jobs:
  call-vercel:
    runs-on: ubuntu-latest

    steps:
      - name: Call Vercel API
        run: |
          curl -X GET https://your-project.vercel.app/api/daily-job
```

> ※ POSTにしたい場合は `curl -X POST` に変更し、必要ならヘッダーやJSONデータも追加。

---

#### ④ 設定後のポイント

* GitHub Actionsは **無料枠内**で1ヶ月あたり数千分動かせます（個人利用なら十分）。
* **GitHubリポジトリがプライベート**でも利用可能です。
* **Vercel側のエンドポイント**は適切に認証やIP制限しないと外部からも叩かれます（セキュリティ注意）。

---

#### ✅ 補足

* 日本時間で動かしたい場合は：

  * `cron: '0 15 * * *'` （UTC+0で15時 → 日本時間の0時）

---

#### ✅ 実際の構成イメージ

| 役割     | 場所             |
| ------ | -------------- |
| データ処理  | Vercel側        |
| 定期実行管理 | GitHub Actions |
| トリガー方法 | HTTPリクエスト      |

---

#### ⑤ もしHTTPS認証やAPIキーを使いたい場合

* `secrets`にAPIキーなどを登録し、curlコマンドで`-H`で送れば対応できます。

例（Authorizationヘッダー）：

```yaml
        run: |
          curl -H "Authorization: Bearer ${{ secrets.VERCEL_API_TOKEN }}" \
               https://your-project.vercel.app/api/daily-job
```

---

#### ✅ 最短で進めたいなら

* **VercelでAPI作成**
* **GitHubに上記yaml設置**
* **テスト実行**

VercelでAPIが**呼ばれたことをログに残す**には、次の方法で対応できます。
Vercelには**コンソールへのサーバーログ出力**機能があるので、それを活用するのが基本です。

---

#### ✅ ログを残す方法

##### ① API Route内で `console.log()` を使う

あなたのVercelの**API Route**内で、リクエストが来たら以下のように記録します：

```javascript
// /api/daily-job.js (例)

export default async function handler(req, res) {
  console.log('✅ API呼び出し検知: ' + new Date().toISOString());
  
  // 必要ならリクエストヘッダーやIPアドレスも記録
  console.log('Headers:', req.headers);

  res.status(200).json({ status: 'OK' });
}
```

Vercelは**console.log()出力をそのままサーバーログとして記録**してくれます。

---

##### ② ログの確認方法

1. [Vercel管理画面](https://vercel.com/)にログイン
2. 対象プロジェクトを選ぶ
3. 左側メニューの「**Functions**」を選択
4. 実行されたAPIルート（`/api/daily-job`など）のログが表示される

   * 1回の呼び出しごとに個別ログ
   * **console.log()の出力内容がすべて表示される**

---

##### ③ ログに記録できる情報例

* 呼ばれた時刻（`new Date().toISOString()`）
* リクエスト元のIPアドレス（`req.headers['x-forwarded-for']`）
* HTTPメソッド（`req.method`）
* 任意のAPIキーなど

---

##### ④ ログ保持の注意

* **Vercelの無料プラン**ではログは**最大1日程度**しか保持されません
* 商用プランでは**最大30日**まで拡張可能

> 長期的なログ保存が必要なら、別途：
>
> * SupabaseやFirebaseに記録する
> * Sentry等の外部ログサービスに送信する
>   …などの対策が必要です

---

#### ✅ まとめ：Vercelログ確認手順

1. API内で\*\*console.log()\*\*を書く
2. [Vercel管理画面 > Functions > ログ](https://vercel.com/)
3. API呼び出しログを一覧確認

---

ログサンプルやAPIソースを具体的に書くこともできます。必要ですか？